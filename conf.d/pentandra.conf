#
# The default server
#
server {
  listen [::]:443 default_server deferred ipv6only=off;

  server_name pentandra.com;

  ssl on;
  ssl_certificate /etc/letsencrypt/live/pentandra.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/pentandra.com/privkey.pem;

  ssl_ciphers "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA";
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_dhparam /etc/letsencrypt/live/pentandra.com/dhparams.pem;
  ssl_session_cache shared:SSL:10m;

  add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;

  ssl_session_tickets off;

  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 8.8.4.4 8.8.8.8 valid=300s;
  resolver_timeout 5s;

  root /srv/http/lifepreserver;

  # Redirect public feed to feedburner
  location /blog/feed {
    return 307 https://feeds.feedburner.com/pentandra;
  }

  # Redirect products → solutions page
  location /products {
    return 301 /solutions/;
  }

  # Redirect /company/funding/ → /company/funders/ page
  location /company/funding {
    return 301 /company/funders/;
  }

  location / {
      index index.html index.htm;
  }

  error_page  404 /404.html;

  # Get detailed info for monitoring
  location /nginx_status {
    stub_status on;
    access_log off;
    allow 75.144.9.40/29;
    deny all;
  }

  # Prevent clients from accessing hidden files (starting with a dot)
  location ~* (^|/)\. {
    return 403;
  }

  # Prevent clients from accessing to backup/config/source files
  location ~* (\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$ {
    return 403;
  }
  
  # Your document html and data
  location ~* \.(?:html|xml|json)$ {
    expires 1h;
    access_log /var/log/nginx/static.log;
    add_header Cache-Control "public";
  }

  # cache.appcache and manifest
  location ~* \.(?:manifest|appcache)$ {
    expires -1;
    access_log /var/log/nginx/static.log;
  }

  # Feed
  location ~* \.(?:rss|atom)$ {
    expires 1h;
    add_header Cache-Control "public";
  }

  # Favicon
  location ~* \.ico$ {
    expires 1w;
    access_log off;
    add_header Cache-Control "public";
  }

  # Media: images, video, audio, HTC, webfonts
  location ~* \.(?:jpg|jpeg|gif|png|gz|svg|svgz|ttf|otf|woff|eot|mp4|ogg|ogv|webm|htc)$ {
    expires 1M;
    access_log off;
    add_header Cache-Control "public";
  }

  # CSS and javascript
  location ~* \.(?:css|js)$ {
    expires 1y;
    access_log off;
    add_header Cache-Control "public";
  }

  # opt-in to the future
  add_header "X-UA-Compatible" "IE=Edge,chrome=1";

}
